# 读我

> 主持人：你有一瓶毒药你要毒谁？毒我？

使用 MATLAB 产生音乐并不困难，基本思路是构造某个音节相应频率的信号，然后组合起来，用 `sound` 函数发声就可以了。本程序目前的结构与基本说明如下：

```text
(functions)
├── getFreqs.m                  # 根据简谱键位的映射计算音节的频率
├── getWave.m                   # 根据主音节频率计算音节波形
├── getMusic.m                  # 汇总，根据定义的节奏生成波形
(scripts)
├── listFreqs.m                 # 列出键位（编码）到频率的映射
├── msc01_kuzao.m               # 示例：枯燥的美丽搭档
└── ...
```

下面按照函数调用顺序简要介绍主要思路。


## 计算频率

虽然我比较喜欢钢琴曲，但是我个人对音乐所知甚少。为了实现简谱到频率的转换，编写 `getFreqs` 程序，这个程序主要负责“翻译工作”，规则如下：

- 数字 `1~7` 分别对应 C 调的 `do`, `re`, `mi`, `fa`, `so`, `la`, `xi`，如果我查的资料没错的话，`la` 对应的频率是 $440.0 \, \rm Hz$ ；
- 以 `0` 结尾的数字代表升半音，仅针对 `do(1)`, `re(2)`,  `fa(4)`, `so(5)`, `la(6)` 成立，比如 `60` 代表 C 升半调的 `la` ；
- 形如 `+mn` 的两位数：`n` 表示基调，`m` 表示跨越多个八度，符号为正表示升，符号为负表示降。比如 `13` 表示 C 的 `mi` 升一个八度，`-210` 表示 C 的 `do` 降两个八度再升一个半音。
  
上面的原理是根据十二均分律，相邻钢琴键盘之间频率成等比数列，对于 88 键的钢琴，第 $49$ 个键为中心频率 $440.0 \, \rm Hz$，则第 $k$ 个键对应的频率是

$$
f(k) = 440.0 \times 2^{\frac{k-49}{12}}
$$

> 本人乐盲，如有勘误请大佬纠正。


## 计算波形

从物理上说，音节的频率有了，直接生成单频信号就行了，但实际上还得有音色的调整。这就要求不能简单生成单频信号，还得有包络和谐波以更加真实。具体可以看 `getWave` 代码，在[这里](https://dsp.stackexchange.com/questions/46598/mathematical-equation-for-the-sound-wave-that-a-piano-makes)参考了 Vinkelman 的回答。

> 之前尝试的 ADSR 效果很差，代码写的也不好，就删除了，有兴趣可以追溯历史，大概在 `e9e46fe` 那次提交……


## 生成音乐

把各个单音节拼起来不就是音乐了嘛！

综合 `getFreqs` 和 `getWave`，`getMusic` 用于直接根据乐谱产生音乐。其需要输入三个变量，分别是：

- `rhythm`：是一个两列的数组，第一列是乐谱的音符，对于 C 调的简谱，直接抄写数字即可，数字上加一个点表示升一个八度，就在前面加个 1 ，以此类推；第二列是该音符持续的时间，呃，我一般直接数简谱空了几个格，然后凭感觉一格是多久，对第二列进行缩放；
- `fs`：采样率，好像高品质音乐都是 44100 Hz ？
- `Tb`：每个单音节持续的时间，时间太短显得急促，好像 3 s 挺舒服。

按顺序计算各个音节的波形，然后叠加即可。

注意：这里我采用的是叠加的策略，也就是说叠加前需要知道整个歌曲波形的长度，置零，然后在对应音符开始的位置加上对应的波形，这样的好处是每个音都可以完整呈现。之前尝试过只生成对应时长的波形然后拼接，导致局部太短听起来太急促。

欢迎提出修改意见，Enjoy yourself !